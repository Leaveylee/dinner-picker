// 歷史記錄相關功能
        function getHistory() {
            return foodHistory;
        }

        function saveHistory(history) {
            foodHistory = history;
        }

        function clearHistory() {
            foodHistory = {};
            updateAvailableCount();
        }

        function clearFilteredHistory() {
            const history = getHistory();
            const filteredItems = getFilteredItems();
            
            filteredItems.forEach(item => {
                delete history[item.name];
            });

            saveHistory(history);
            updateAvailableCount();
        }

        function updateAvailableCount() {
            const filteredItems = getFilteredItems();
            const availableCount = filteredItems.filter(item => isAvailable(item.name)).length;
            const elem = document.getElementById('remainingChoices');
            elem.textContent = `🍚 可選擇的餐點：${availableCount}/${filteredItems.length}`;
        }

        // 隨機選擇食物的主要功能
        function pickFood() {
            if (isAnimating) return;

            const resultElem = document.getElementById('result');
            const buttonElem = document.getElementById('pickButton');
            const recipeButton = document.getElementById('recipeButton');
            const mapButton = document.getElementById('mapButton');
            const favoriteButton = document.getElementById('favoriteButton');
            
            isAnimating = true;
            buttonElem.disabled = true;
            resultElem.classList.add('animating');
            recipeButton.style.display = 'none';
            mapButton.style.display = 'none';
            favoriteButton.style.display = 'none';

            let finalChoice = null;
            let counter = 0;
            
            const spinInterval = setInterval(() => {
                if (counter === 0) {
                    finalChoice = getRandomFood();
                }

                if (counter < 9) {
                    const filteredItems = getFilteredItems();
                    const randomItem = filteredItems[Math.floor(Math.random() * filteredItems.length)];
                    resultElem.textContent = randomItem.name;
                } else {
                    resultElem.textContent = finalChoice;
                }
                
                counter++;
                if (counter >= 10) {
                    clearInterval(spinInterval);
                    isAnimating = false;
                    buttonElem.disabled = false;
                    resultElem.classList.remove('animating');
                    
                    if (finalChoice) {
                        const history = getHistory();
                        history[finalChoice] = new Date().toISOString();
                        saveHistory(history);
                        currentFood = finalChoice;
                        
                        // 更新UI元素
                        updateFavoriteButton();
                        
                        // 顯示食譜按鈕（如果有食譜）
                        recipeButton.style.display = recipes[finalChoice] ? 'flex' : 'none';
                        
                        // 顯示地圖按鈕
                        mapButton.style.display = 'flex';
                        favoriteButton.style.display = 'flex';
                    }
                    
                    updateAvailableCount();
                }
            }, 100);
        }

        // 頁面初始化
        window.onload = function() {
            // 初始化計數
            updateAvailableCount();

            // 檢查位置權限
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    position => {
                        hasLocationPermission = true;
                        lastKnownPosition = position;
                        startWatchingPosition();
                    },
                    error => {
                        hasLocationPermission = false;
                        console.log('位置權限未獲得:', error.message);
                    },
                    { enableHighAccuracy: true }
                );
            }

            // 監聽篩選器變化
            document.getElementById('countryFilter').addEventListener('change', handleCategoryChange);
            document.getElementById('priceFilter').addEventListener('change', updateAvailableCount);

            // 初始化模態框關閉按鈕
            const closeButtons = document.getElementsByClassName('close');
            Array.from(closeButtons).forEach(button => {
                button.onclick = function() {
                    const modal = this.closest('.modal');
                    if (modal) {
                        modal.style.display = 'none';
                    }
                };
            });

            // 點擊模態框外部關閉
            window.onclick = function(event) {
                if (event.target.classList.contains('modal')) {
                    event.target.style.display = 'none';
                }
            };

            // 清除之前的位置監控（如果有的話）
            stopWatchingPosition();
        };

        // 頁面卸載時清理
        window.onbeforeunload = function() {
            stopWatchingPosition();
        };
    </script>
</body>
</html>
