// æ­·å²è¨˜éŒ„ç›¸é—œåŠŸèƒ½
        function getHistory() {
            return foodHistory;
        }

        function saveHistory(history) {
            foodHistory = history;
        }

        function clearHistory() {
            foodHistory = {};
            updateAvailableCount();
        }

        function clearFilteredHistory() {
            const history = getHistory();
            const filteredItems = getFilteredItems();
            
            filteredItems.forEach(item => {
                delete history[item.name];
            });

            saveHistory(history);
            updateAvailableCount();
        }

        function updateAvailableCount() {
            const filteredItems = getFilteredItems();
            const availableCount = filteredItems.filter(item => isAvailable(item.name)).length;
            const elem = document.getElementById('remainingChoices');
            elem.textContent = `ğŸš å¯é¸æ“‡çš„é¤é»ï¼š${availableCount}/${filteredItems.length}`;
        }

        // éš¨æ©Ÿé¸æ“‡é£Ÿç‰©çš„ä¸»è¦åŠŸèƒ½
        function pickFood() {
            if (isAnimating) return;

            const resultElem = document.getElementById('result');
            const buttonElem = document.getElementById('pickButton');
            const recipeButton = document.getElementById('recipeButton');
            const mapButton = document.getElementById('mapButton');
            const favoriteButton = document.getElementById('favoriteButton');
            
            isAnimating = true;
            buttonElem.disabled = true;
            resultElem.classList.add('animating');
            recipeButton.style.display = 'none';
            mapButton.style.display = 'none';
            favoriteButton.style.display = 'none';

            let finalChoice = null;
            let counter = 0;
            
            const spinInterval = setInterval(() => {
                if (counter === 0) {
                    finalChoice = getRandomFood();
                }

                if (counter < 9) {
                    const filteredItems = getFilteredItems();
                    const randomItem = filteredItems[Math.floor(Math.random() * filteredItems.length)];
                    resultElem.textContent = randomItem.name;
                } else {
                    resultElem.textContent = finalChoice;
                }
                
                counter++;
                if (counter >= 10) {
                    clearInterval(spinInterval);
                    isAnimating = false;
                    buttonElem.disabled = false;
                    resultElem.classList.remove('animating');
                    
                    if (finalChoice) {
                        const history = getHistory();
                        history[finalChoice] = new Date().toISOString();
                        saveHistory(history);
                        currentFood = finalChoice;
                        
                        // æ›´æ–°UIå…ƒç´ 
                        updateFavoriteButton();
                        
                        // é¡¯ç¤ºé£Ÿè­œæŒ‰éˆ•ï¼ˆå¦‚æœæœ‰é£Ÿè­œï¼‰
                        recipeButton.style.display = recipes[finalChoice] ? 'flex' : 'none';
                        
                        // é¡¯ç¤ºåœ°åœ–æŒ‰éˆ•
                        mapButton.style.display = 'flex';
                        favoriteButton.style.display = 'flex';
                    }
                    
                    updateAvailableCount();
                }
            }, 100);
        }

        // é é¢åˆå§‹åŒ–
        window.onload = function() {
            // åˆå§‹åŒ–è¨ˆæ•¸
            updateAvailableCount();

            // æª¢æŸ¥ä½ç½®æ¬Šé™
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    position => {
                        hasLocationPermission = true;
                        lastKnownPosition = position;
                        startWatchingPosition();
                    },
                    error => {
                        hasLocationPermission = false;
                        console.log('ä½ç½®æ¬Šé™æœªç²å¾—:', error.message);
                    },
                    { enableHighAccuracy: true }
                );
            }

            // ç›£è½ç¯©é¸å™¨è®ŠåŒ–
            document.getElementById('countryFilter').addEventListener('change', handleCategoryChange);
            document.getElementById('priceFilter').addEventListener('change', updateAvailableCount);

            // åˆå§‹åŒ–æ¨¡æ…‹æ¡†é—œé–‰æŒ‰éˆ•
            const closeButtons = document.getElementsByClassName('close');
            Array.from(closeButtons).forEach(button => {
                button.onclick = function() {
                    const modal = this.closest('.modal');
                    if (modal) {
                        modal.style.display = 'none';
                    }
                };
            });

            // é»æ“Šæ¨¡æ…‹æ¡†å¤–éƒ¨é—œé–‰
            window.onclick = function(event) {
                if (event.target.classList.contains('modal')) {
                    event.target.style.display = 'none';
                }
            };

            // æ¸…é™¤ä¹‹å‰çš„ä½ç½®ç›£æ§ï¼ˆå¦‚æœæœ‰çš„è©±ï¼‰
            stopWatchingPosition();
        };

        // é é¢å¸è¼‰æ™‚æ¸…ç†
        window.onbeforeunload = function() {
            stopWatchingPosition();
        };
    </script>
</body>
</html>
